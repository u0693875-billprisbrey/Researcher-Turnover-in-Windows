---
title: "Demonstrating Brute Force Fit"
author: "Bill Prisbrey"
date: "2025-10-21"
output:
  html_document:
    keep_md: true
---


```{r include=FALSE}

# Author's notes:

# I want a handful of flowcharts showing the breakdown of the individual journey,
# with the counts or percentages of the different "regimes"

# Then I want a handful of individual journey plots demonstrating the different regimes

# I should have my "boundary" graphic at the bottom as well



```

  
```{r include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.height=7, fig.width=10)

# adjust graphic parameters

oldPar <- par(cex.main = 3,
    cex.lab = 3,
    cex.axis = 2,
    mar = c(5.1,4.1,4.1,2.1), # default is c(5.1,4.1,4.1,2.1)
    mfrow = c(1,1)
    )

```


```{r}

##########
## LOAD ##
##########

journeyPopulation <- readRDS(here::here("Data", "journeyPopulation.rds") )
piEMPLIDs <- readRDS(here::here("Data", "piEMPLIDs.rds") )

ex_diff <- readRDS(here::here("Data", "exclusiveJourney_timeDiff.rds") )
cj_diff <- readRDS(here::here("Data", "concurrentJourney_timeDiff.rds") )
cjEmplids <- readRDS(here::here("Data", "Journey Activity from Brute Force Fit Approximation for Concurrent Journey Employees.rds"))
univBound <- readRDS(here::here("Data", "Brute Force Fit Approximation for Concurrent Journey Employees.rds") )


source(here::here("Functions", "Turnover Functions.R"))
source(here::here("Functions", "Brute Force Functions.R"))


library(lubridate)
library(RColorBrewer)

```

```{r}

###############
## FUNCTIONS ##
###############






```

```{r}

##########
## PREP ##
##########

# flowchart conditionals
journeyPopulation$wb <- journeyPopulation$WORKBREAK == "wb"
journeyPopulation$lv <- journeyPopulation$LEAVE == "leave"

journeyPopulation$PI <- journeyPopulation$EMPLID %in% piEMPLIDs
journeyPopulation$singleJob <- journeyPopulation$HCJ == "not_hcj" & journeyPopulation$SINGLERCD == "single_rcd"



```


**PURPOSE:**


**OBJECTIVES:**

### Population breakdown by journey characteristics 

```{r}

################
## FLOWHCHART ##
################

library(flowchart)

# Showing split between concurrent and non-concurrent jobs

journeyPopulation |>
  as_fc(label = "Workforce population", text_fs = 12) |>
  fc_filter(PI, label = "Principal investigators", show_exc = TRUE) |>
  #fc_split(PI, label = c("Not PI", "PI")) |>
  fc_split(singleJob, label = c("Concurrent jobs", "No concurrent jobs"), bg_fill = "ivory", text_fs = 12) |> 
  fc_draw()


journeyPopulation |>
  (\(x){x[x$PI & !x$singleJob,]})() |>
  as_fc(label = "Concurrent jobs", text_fs = 12) |>
  fc_split(wb, label = c("No work break", "Work break"), bg_fill = "mintcream", text_fs = 12) |>
  fc_split(lv, label = c("No leave", "leave"), bg_fill = "plum1", text_fs = 12) |>
  fc_draw()


journeyPopulation |>
  (\(x){x[x$PI & x$singleJob,]})() |>
  as_fc(label = "Exclusive jobs", text_fs = 12) |>
  fc_split(wb, label = c("No work break", "Work break"), bg_fill = "mintcream", text_fs = 12) |>
  fc_split(lv, label = c("No leave", "leave"), bg_fill = "plum1", text_fs = 12) |>
  fc_draw()

```

### Individual journeys 

#### **EXCLUSIVE JOURNEY**

```{r}



exc_wb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]

exc_nwb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]

exc_wb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]

exc_nwb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]

exclusivePopulation <- list(exc_wb_lv, exc_nwb_nlv, exc_wb_nlv, exc_nwb_lv)

set.seed(99)
excSample <- sapply(exclusivePopulation, function(x){sample(x,1)} )

# Plot it

par(mfrow = c(3,1), mar = c(0,2,2,1))

for(pi in excSample) {
  
ex_diff[[paste(pi,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()  
  
}

par(mfrow = c(1,1))
plotJourneyKey()






ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()



```

#### **CONCURRENT JOURNEY**

***No work break, no leave***

```{r}

conc_nwb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           !journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]


# sample(conc_nwb_nlv,1)
selectPI <- "00954937"

par(mfrow= c(2,1))

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = FALSE)

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = TRUE)

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

addVerticals(univBound[grep(selectPI, row.names(univBound)),])

```



***Work break, no leave***


```{r}

conc_wb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           !journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]


# sample(conc_wb_nlv,1)
selectPI <- "00292990"

par(mfrow= c(2,1))

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = FALSE)

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = TRUE)

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

addVerticals(univBound[grep(selectPI, row.names(univBound)),])

```


***No work break, leave***


```{r}

conc_nwb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           !journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]


# sample(conc_nwb_lv,1)
selectPI <- "00244272"

par(mfrow= c(2,1))

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = FALSE)

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = TRUE)

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

addVerticals(univBound[grep(selectPI, row.names(univBound)),])

```


***Work break and leave***  

```{r}

conc_wb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           !journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]


# sample(conc_wb_lv,1)
selectPI <- "00028851"

par(mfrow= c(2,1))

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = FALSE)

cjEmplids[[selectPI]] |>
  forceFitPlot(fitLine = TRUE)

cjEmplids[[selectPI]] |>
  assignBoundaries() |>
  plotJourney()

addVerticals(univBound[grep(selectPI, row.names(univBound)),])

```



### Headcount Metrics 

#### **PI's WITH EXCLUSIVE JOBS**

```{r}


```


#### **PI's WITH CONCURRENT JOBS**

```{r}


univBound |>
  (\(x){ 
    calculateMetrics_univ(data = x)
  })() |> 
  plotMetrics_univ()


```

#### **ALL PI's**

```{r}


```

### Explain HeadCount

```{r}

explainHeadCount()

```  

'Exit' condition needs to be modified to accommodate the transfer to volunteer positions

*Per Brian Gelsinger, Teams message on 14 Oct 2025:*

I can't remember if we included the field UU_BEN_IND in the SQL we provided, but that would be my recommendation to use. A Benefit Indicator of "30 " means that job code is considered "Non-Employee". I'm happy to add that field to the SQL if you'd like, but below is a list of all the job codes in Ben Ind 30, so you could just try excluding those job codes as well. I've also provided the current headcount of employees in these job codes
 
Job Code	Job Title	UU Ben Ind	UU Ben Ind Descr	Count Distinct EE
0233	Field Instructor	30	Non-Employee	15
6000	Volunteer Staff	30	Non-Employee	21
6001	Volunteer Faculty	30	Non-Employee	34
6002	Adjunct Professor	30	Non-Employee	474
6003	Adjunct Associate Professor	30	Non-Employee	371
6004	Adjunct Assistant Professor	30	Non-Employee	748
6005	Adjunct Instructor	30	Non-Employee	588
6006	Shared Faculty (Unpaid)	30	Non-Employee	17
6100	Univ Asia Staff	30	Non-Employee	56
6102	Adjunct Professor (Ext)	30	Non-Employee	134
6103	Adjunct Assoc Professor (Ext)	30	Non-Employee	126
6104	Adjunct Asst Professor (Ext)	30	Non-Employee	784
6105	Adjunct Instructor (Ext)	30	Non-Employee	416
7993	Surviving Spouse	30	Non-Employee	0
9261	COBRA Beneficiary	30	Non-Employee	0
799999	Volunteer Staff	30	Non-Employee	0 

#### **EXCLUSIVE JOURNEY**  

***No work break, no leave***


```{r}

exc_nwb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]


# sample(exc_nwb_nlv,1)
selectPI <- "06025740"

par(mfrow= c(3,1))

plotJourneyKey()

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = FALSE)

par(mfrow= c(2,1))

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = TRUE)

plot(x=0.5,
  type = "n",
     ylim = c(0,1),
     xlim = c(0,1),
  ylab = "",
  xlab = "",
     xaxt = "n",
     yaxt = "n")

text(0.5, 0.5, "University boundaries not calculated")


```



***Work break, no leave***


```{r}

exc_wb_nlv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           !journeyPopulation$lv
                                           ]


# sample(exc_wb_nlv,1)
selectPI <- "00703457"

par(mfrow= c(2,1))

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = FALSE)

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = TRUE)

plot(x=0.5,
  type = "n",
     ylim = c(0,1),
     xlim = c(0,1),
  ylab = "",
  xlab = "",
     xaxt = "n",
     yaxt = "n")

text(0.5, 0.5, "University boundaries not calculated")


```


***No work break, leave***


```{r}

exc_nwb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           !journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]


# sample(exc_nwb_lv,1)
selectPI <- "06022652"

par(mfrow= c(2,1))

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = FALSE)

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = TRUE)

plot(x=0.5,
  type = "n",
     ylim = c(0,1),
     xlim = c(0,1),
  ylab = "",
  xlab = "",
     xaxt = "n",
     yaxt = "n")

text(0.5, 0.5, "University boundaries not calculated")


```




***Work break and leave***  


```{r}

exc_wb_lv <- journeyPopulation$EMPLID[journeyPopulation$PI &
                                           journeyPopulation$singleJob &
                                           journeyPopulation$wb &
                                           journeyPopulation$lv
                                           ]


# sample(exc_wb_lv,1)
selectPI <- "06012575"

par(mfrow= c(2,1))

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  assignBoundaries() |>
  plotJourney()

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = FALSE)

ex_diff[[paste(selectPI,"0", sep = ".")]] |>
  forceFitPlot(fitLine = TRUE)

plot(x=0.5,
  type = "n",
     ylim = c(0,1),
     xlim = c(0,1),
  ylab = "",
  xlab = "",
     xaxt = "n",
     yaxt = "n")

text(0.5, 0.5, "University boundaries not calculated")


```



